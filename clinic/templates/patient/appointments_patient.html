{% extends "patient/base_patient.html" %}
{% block title %}นัดหมายของฉัน{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
  <!-- หัวข้อหลัก -->
  <h1 class="text-2xl font-bold mb-6 text-indigo-700 flex items-center">
    <i class="fa-solid fa-calendar-check mr-2 text-indigo-500"></i>
    นัดหมายทั้งหมดของฉัน
  </h1>

  <!-- ✅ แสดงข้อความแจ้งเตือน -->
  {% if messages %}
  <div class="mb-4">
    {% for message in messages %}
    <div class="px-4 py-3 rounded-lg mb-2 shadow-sm
                {% if message.tags == 'error' %} bg-red-100 text-red-700 border border-red-300
                {% elif message.tags == 'success' %} bg-green-100 text-green-700 border border-green-300
                {% else %} bg-gray-100 text-gray-700 border border-gray-300 {% endif %}">
      {{ message }}
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- ฟอร์มเพิ่มนัดหมาย -->
  <div class="bg-white p-6 mb-8 rounded-xl shadow-lg border border-indigo-100">
    <h2 class="text-xl font-semibold mb-4 text-indigo-600 flex items-center">
      <i class="fa-solid fa-plus-circle mr-2 text-green-500"></i>
      เพิ่มนัดหมายใหม่
    </h2>
    <form method="post" class="space-y-4">
      {% csrf_token %}
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">ทันตแพทย์</label>
          {{ form.dentist }}
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">บริการ</label>
          {{ form.service }}
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">วันที่</label>
          {{ form.appointment_date }}
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">เวลาเริ่ม</label>
          {{ form.start_time }}
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">หมายเหตุ</label>
        {{ form.notes }}
      </div>

      <button type="submit"
              class="mt-3 bg-gradient-to-r from-indigo-500 to-violet-600 text-white px-5 py-2.5 rounded-lg shadow hover:opacity-90 transition">
        <i class="fa-solid fa-save mr-2"></i> บันทึกนัดหมาย
      </button>
    </form>
  </div>

  <!-- ตารางนัดหมาย -->
  <div class="bg-white rounded-lg shadow overflow-hidden border border-indigo-100">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-violet-50">
        <tr>
          <th class="px-6 py-3 text-left text-sm font-semibold">วันที่</th>
          <th class="px-6 py-3 text-left text-sm font-semibold">เวลา</th>
          <th class="px-6 py-3 text-left text-sm font-semibold">ทันตแพทย์</th>
          <th class="px-6 py-3 text-left text-sm font-semibold">บริการ</th>
          <th class="px-6 py-3 text-left text-sm font-semibold">สถานะ</th>
          <th class="px-6 py-3 text-center text-sm font-semibold">การจัดการ</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        {% for a in appointments %}
        <tr class="hover:bg-indigo-50 transition">
          <td class="px-6 py-4">{{ a.appointment_date }}</td>
          <td class="px-6 py-4">{{ a.start_time }}{% if a.end_time %} - {{ a.end_time }}{% endif %}</td>
          <td class="px-6 py-4">{{ a.dentist.name }}</td>
          <td class="px-6 py-4">{{ a.service.name }}</td>
          <td class="px-6 py-4">
            <span class="px-2 py-1 rounded text-xs font-medium
              {% if a.status == 'scheduled' %} bg-yellow-100 text-yellow-700
              {% elif a.status == 'confirmed' %} bg-blue-100 text-blue-700
              {% elif a.status == 'completed' %} bg-green-100 text-green-700
              {% elif a.status == 'cancelled' %} bg-red-100 text-red-700
              {% else %} bg-gray-100 text-gray-700 {% endif %}">
              {{ a.get_status_display }}
            </span>
          </td>
          <td class="px-6 py-4 text-center">
            {% if a.status == "scheduled" %}
              <div class="flex flex-col items-center space-y-2">
                {# ปุ่มยืนยัน เฉพาะ Admin เป็นคนสร้าง #}
                {% if a.created_by and a.created_by.role == "admin" %}
                  <a href="{% url 'appointment_confirm' a.pk %}"
                     class="text-indigo-600 hover:text-indigo-800 ml-3" title="ยืนยันการนัดหมาย"
                     onclick="return confirm('คุณแน่ใจหรือไม่ที่จะยืนยันนัดหมายนี้?');">
                    <i class="fa-solid fa-square-check"></i>
                  </a>
                {% endif %}

                {# ปุ่มแก้ไข เฉพาะผู้ป่วยที่สร้างเอง #}
                {% if a.created_by and a.created_by.role == "patient" %}
                  <a href="{% url 'appointment_edit_patient' a.pk %}"
                     class="text-indigo-600 hover:text-indigo-800 ml-3" title="แก้ไขรายการนัดหมาย">
                    <i class="fa-solid fa-pen-to-square"></i>
                  </a>
                {% endif %}

                {# ปุ่มยกเลิก (ทุกกรณี) #}
                <a href="{% url 'appointment_cancel' a.pk %}"
                   class="text-red-600 hover:text-red-800 ml-3" title="ยกเลิกนัดหมาย"
                   onclick="return confirm('คุณแน่ใจหรือไม่ที่จะยกเลิกนัดหมายนี้?');">
                   <i class="fa-solid fa-rectangle-xmark"></i>
                </a>
              </div>
            {% elif a.created_by and a.created_by.role == "patient" %}
              <!-- แก้ไขสถานะผ่าน modal -->
              <button onclick="openStatusModal({{ a.id }}, '{{ a.status }}')"
                      class="text-indigo-600 hover:text-indigo-800 ml-3" title="แก้ไขสถานะนัดหมาย">
                <i class="fa-solid fa-file-pen"></i>
              </button>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="px-6 py-4 text-center text-gray-500">ยังไม่มีนัดหมาย</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal สำหรับแก้ไขสถานะ -->
<div id="statusModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl shadow-lg p-6 w-96">
    <h2 class="text-lg font-semibold mb-4">แก้ไขสถานะการนัดหมาย</h2>
    <form method="post" id="statusForm">
      {% csrf_token %}
      <input type="hidden" name="appointment_id" id="appointmentId">

      <label class="block mb-2 text-sm font-medium">เลือกสถานะ</label>
      <select name="status" id="appointmentStatus"
              class="w-full rounded-lg border-gray-300 focus:ring-indigo-500 focus:border-indigo-500">
        <option value="confirmed">Confirmed</option>
        <option value="cancelled">Cancelled</option>
      </select>

      <div class="flex justify-end mt-6 space-x-3">
        <button type="button" onclick="closeStatusModal()"
                class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">ยกเลิก</button>
        <button type="submit"
                class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">บันทึก</button>
      </div>
    </form>
  </div>
</div>

<script>
function openStatusModal(apptId, currentStatus) {
  document.getElementById("statusModal").classList.remove("hidden");
  document.getElementById("appointmentId").value = apptId;
  document.getElementById("appointmentStatus").value = currentStatus;
  document.getElementById("statusForm").action = `/appointments/${apptId}/update-status/`;
}

function closeStatusModal() {
  document.getElementById("statusModal").classList.add("hidden");
}
</script>
{% endblock %}
